:80 {
    # Backend health check
    handle /health {
        reverse_proxy backend:8000
    }

    # OpenAI-compatible proxy (used by Open WebUI)
    handle /v1/* {
        reverse_proxy backend:8000
    }

    # Route file uploads through backend for interception
    handle /api/v1/files* {
        reverse_proxy backend:8000
    }

    # WebSocket for prompt stream
    handle /ws/* {
        reverse_proxy backend:8000
    }

    # Backend API
    handle /api/* {
        reverse_proxy backend:8000
    }

    # Frontend (catch-all)
    handle /* {
        reverse_proxy frontend:3000
    }
}

# Open WebUI on dedicated port (iframe-friendly, no path conflicts)
:{$OPENWEBUI_PORT} {
    # Intercept file uploads on iframe port too (handle = exclusive, no fallthrough)
    handle /api/v1/files* {
        reverse_proxy backend:8000
    }
    handle {
        reverse_proxy open-webui:8081
    }
}
